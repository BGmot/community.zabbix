---
- name: check login to zabbix
  uri:
    url: "{{ zabbix_api_server_url }}/api_jsonrpc.php"
    method: POST
    body:
      jsonrpc: "2.0"
      method: "user.login"
      params:
        user: "{{ zabbix_api_login_user }}"
        password: "{{ zabbix_api_login_pass }}"
      id: "1"
    body_format: json
    status_code: 200
  retries: 60
  delay: 5
  until: check_login_result is defined and 'json' in check_login_result and 'result' in check_login_result.json
  register: check_login_result

- name: get zabbix version
  uri:
    url: "{{ zabbix_api_server_url }}/api_jsonrpc.php"
    method: POST
    body:
      jsonrpc: "2.0"
      method: "apiinfo.version"
      params: []
      id: "1"
    body_format: json
    status_code: 200
  register: zabbix_version_result

- name: set zabbix_version variable
  set_fact:
    zabbix_version: >-
      {{ [0,1]
        | map('extract', zabbix_version_result.json.result.split('.'))
        | list
        | join('.')
      }}
    ansible_network_os: community.zabbix.zabbix
    ansible_connection: ansible.netcommon.httpapi
    #ansible_httpapi_session_key:
    #  auth: 2920b1179da3041e23e60e38b421cd95582fc6b8ae06763e4979580d0fa7c8be
    ansible_host: 127.0.0.1
    ansible_httpapi_port: 8080
    ansible_httpapi_use_ssl: false
    ansible_httpapi_validate_certs: false
    ansible_user: Admin
    ansible_httpapi_pass: zabbix
